<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>HÄ±zlÄ± DeÄŸerlendirme (E-Triaj) Sistemi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="logo.png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #2563eb;
      --primary-light: #3b82f6;
      --primary-dark: #1d4ed8;
      --secondary: #64748b;
      --success: #059669;
      --warning: #d97706;
      --danger: #dc2626;
      --bg-primary: #ffffff;
      --bg-secondary: #f8fafc;
      --bg-card: #ffffff;
      --text-primary: #1e293b;
      --text-secondary: #475569;
      --text-muted: #64748b;
      --border: #e2e8f0;
      --border-light: #cbd5e1;
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-secondary);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
      padding-top: 60px;
    }

    header {
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border);
      padding: 0.75rem 1rem;
      box-shadow: var(--shadow);
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
    }

    .header-container {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo-section {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .logo {
      width: 32px;
      height: 32px;
      background: var(--primary);

;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 1rem;
      overflow: hidden;
    }

    .logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 8px;
    }

    .header-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }

    .header-subtitle {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin: 0;
      display: none;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .user-avatar {
      width: 28px;
      height: 28px;
      background: var(--primary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 500;
      font-size: 0.75rem;
    }

    main {
      max-width: 1400px;
      margin: 1.5rem auto;
      padding: 0 1rem 2rem;
      display: grid;
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }

    @media (min-width: 768px) {
      main {
        grid-template-columns: 500px 1fr;
        gap: 2rem;
      }
    }

    .input-section {
      max-width: 500px;
    }

    .results-section {
      min-height: 600px;
    }

    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: var(--shadow);
      transition: all 0.2s ease;
    }

    .card:hover {
      box-shadow: var(--shadow-lg);
      border-color: var(--border-light);
    }

    .card h2 {
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: 1.25rem;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .card h2::before {
      content: '';
      width: 4px;
      height: 1.25rem;
      background: var(--primary);
      border-radius: 2px;
    }

    .section-icon {
      width: 20px;
      height: 20px;
      background: var(--primary);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.75rem;
      font-weight: 600;
    }

    label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-primary);
      margin: 1rem 0 0.5rem;
    }

    input, select, textarea {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg-primary);
      color: var(--text-primary);
      font-size: 0.875rem;
      transition: all 0.2s ease;
      outline: none;
      font-family: inherit;
    }

    input:focus, select:focus, textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    textarea {
      min-height: 80px;
      resize: vertical;
      font-family: inherit;
    }

    .row, .grid2 {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
    }

    @media (min-width: 640px) {
      .row, .grid2 {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      min-height: 44px;
    }

    .btn:hover {
      background: var(--primary-dark);
      box-shadow: var(--shadow-lg);
    }

    .btn.secondary {
      background: var(--bg-primary);
      border: 1px solid var(--border);
      color: var(--text-secondary);
    }

    .btn.secondary:hover {
      background: var(--bg-secondary);
      border-color: var(--border-light);
    }

    .btn.success {
      background: var(--success);
      color: white;
    }

    .btn.success:hover {
      background: #059669;
    }

    .btn.warning {
      background: var(--warning);
      color: white;
    }

    .btn.warning:hover {
      background: #d97706;
    }

    .btn.danger {
      background: var(--danger);
      color: white;
    }

    .btn.danger:hover {
      background: #dc2626;
    }

    .split {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
    }

    .split > * {
      flex: 1;
    }

    .status {
      display: flex;
      gap: 0.75rem;
      align-items: center;
      flex-wrap: wrap;
      margin: 1rem 0;
      padding: 1rem;
      background: var(--bg-secondary);
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      border-radius: 20px;
      border: 1px solid var(--border);
      font-weight: 500;
      font-size: 0.75rem;
      background: var(--bg-primary);
      color: var(--text-primary);
    }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .green { background: var(--success); }
    .yellow { background: var(--warning); }
    .red { background: var(--danger); }

    /* ESI Color Coding for Result Summary */
    .result-summary.esi-1,
    .result-summary.esi-2 {
      border-left: 4px solid #ef4444;
      background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
    }

    .result-summary.esi-3 {
      border-left: 4px solid #f59e0b;
      background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
    }

    .result-summary.esi-4,
    .result-summary.esi-5 {
      border-left: 4px solid #10b981;
      background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
    }

    .result-summary.esi-1 .status-text, .esiBadge
    .result-summary.esi-2 .status-text, .esiBadge {
      color: #dc2626;
      font-weight: 700;
    }

    .result-summary.esi-3 .status-text,.esiBadge {
      color: #d97706;
      font-weight: 700;
    }

    .result-summary.esi-4 .status-text,.esiBadge
    .result-summary.esi-5 .status-text,.esiBadge {
      color: #059669;
      font-weight: 700;
    }

    .qa {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1.25rem;
      margin: 1rem 0;
    }

    .hr {
      height: 1px;
      background: var(--border);
      margin: 1.5rem 0;
      border: none;
    }

    .small {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .muted {
      color: var(--text-muted);
    }

    .success { color: var(--success); }
    .warn { color: var(--warning); }
    .err { color: var(--danger); }

    .link {
      color: var(--primary);
      text-decoration: none;
      transition: color 0.2s ease;
    }

    .link:hover {
      color: var(--primary-dark);
      text-decoration: underline;
    }

    .mono {
      font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
      font-size: 0.75rem;
      background: var(--bg-secondary);
      padding: 0.5rem;
      border-radius: 4px;
      border: 1px solid var(--border);
    }

    ul {
      margin: 0.5rem 0 0 1.25rem;
      padding: 0;
    }

    li {
      margin: 0.25rem 0;
      color: var(--text-secondary);
    }

    .info-card {
      background: var(--primary);
;
      color: white;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
    }

    .info-card h3 {
      margin: 0 0 0.5rem 0;
      font-size: 1rem;
      font-weight: 600;
    }

    .info-card p {
      margin: 0;
      font-size: 0.875rem;
      opacity: 0.9;
    }

    /* Results Panel Styles */
    .result-summary {
      background: var(--bg-secondary);
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }

    .status-text {
      font-weight: 600;
      color: var(--text-primary);
    }

    .badges-container {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .badge.primary {
      background: #6b7280;
      color: white;
    }

    .badge.secondary {
      background: #6b7280;
      color: white;
    }

    .badge.tertiary {
      background: #6b7280;
      color: white;
    }

    /* ESI Badge Color Coding */
    .badge.esi-1,
    .badge.esi-2 {
      background: #ef4444;
      color: white;
      font-weight: 700;
    }

    .badge.esi-3 {
      background: #f59e0b;
      color: white;
      font-weight: 700;
    }

    .badge.esi-4,
    .badge.esi-5 {
      background: #10b981;
      color: white;
      font-weight: 700;
    }

    .rationale-section {
      margin-bottom: 1.5rem;
    }

    .rationale-section h3 {
      margin: 0 0 0.75rem 0;
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .rationale-content {
      background: var(--bg-secondary);
      padding: 0.75rem;
      border-radius: 6px;
      font-size: 0.875rem;
      line-height: 1.5;
      border-left: 3px solid #3b82f6;
    }

    .section-block {
      margin-bottom: 1.5rem;
    }

    .section-block h3 {
      margin: 0 0 0.75rem 0;
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .findings-list {
      margin: 0;
      padding-left: 1.25rem;
    }

    .findings-list li {
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
      line-height: 1.4;
    }

    /* Responsive improvements */
    @media (max-width: 768px) {
      main {
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }

      .input-section {
        max-width: none;
      }

      .header-container {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
      }
      
      .logo-section {
        justify-content: center;
      }
      
      .user-info {
        justify-content: center;
      }

      .badges-container {
        flex-direction: column;
        align-items: flex-start;
      }

      .result-summary {
        padding: 0.75rem;
      }
    }

    @media (max-width: 640px) {
      header {
        padding: 1rem;
      }
      
      main {
        margin: 1rem auto;
        padding: 0 0.75rem 2rem;
      }
      
      .card {
        padding: 1rem;
      }
      
      .split {
        flex-direction: column;
      }

      .rationale-content {
        padding: 0.5rem;
        font-size: 0.8rem;
      }

      .section-block h3 {
        font-size: 0.8rem;
      }
    }

    /* Loading animation */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .loading {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-container">
      <div class="logo-section">
        <div class="logo">
          <img src="logo.png" alt="">
        </div>
        <div>
          <h1 class="header-title">HÄ±zlÄ± DeÄŸerlendirme (E-Triaj) Sistemi</h1>
          <p class="header-subtitle">KiÅŸisel SaÄŸlÄ±k Bilgilerinizi YÃ¶netebileceÄŸiniz TÃ¼rkiye'nin GÃ¼venilir KiÅŸisel SaÄŸlÄ±k KayÄ±t Sistemidir.</p>
        </div>
      </div>
      <div class="user-info">
        <span>Aile Hekimi GiriÅŸi</span>
        <div class="user-avatar">AH</div>
      </div>
    </div>
  </header>

  <main>
    <!-- SOL: GiriÅŸ & Soru AkÄ±ÅŸÄ± -->
    <section class="card input-section">
      <div class="info-card">
        <h3>Triaj DeÄŸerlendirme</h3>
        <p>Hasta bilgilerini girin ve sistemin sorularÄ±nÄ± yanÄ±tlayÄ±n</p>
      </div>
      
      <h2></span>Hasta Bilgisi</h2>

      <div class="row">
        <div>
          <label>YaÅŸ</label>
          <input id="age" type="number" min="0" value="30" />
        </div>
        <div>
          <label>Cinsiyet</label>
          <select id="sex">
            <option value="F">KadÄ±n</option>
            <option value="M">Erkek</option>
          </select>
        </div>
      </div>

      <label>ÅžikÃ¢yet metni</label>
      <textarea id="complaint" placeholder="Ã¶rn. gÃ¶ÄŸsÃ¼mde baskÄ± var, nefes almakta zorlanÄ±yorum"></textarea>

      <div class="grid2">
        <div>
          <label>Gebelik</label>
          <select id="pregnancy">
            <option value="any" selected>SeÃ§ilmedi</option>
            <option value="positive">Pozitif</option>
            <option value="negative">Negatif</option>
          </select>
        </div>
        <div>
          <label>HastalÄ±k Ã–zeti</label>
          <input id="chief" placeholder="GÃ¶ÄŸÃ¼s aÄŸrÄ±sÄ±" />
        </div>
      </div>

      <label>Vitaller (JSON, opsiyonel)</label>
      <textarea id="vitals" class="mono" placeholder='Ã¶rn. {"HR": 110, "RR": 24, "SpO2": 93, "SBP": 118, "Temp": 37.8}'></textarea>

      <div class="hr"></div>
      <div class="split">
        <button class="btn" id="startBtn">BaÅŸla</button>
        <button class="btn secondary" id="resetBtn">SÄ±fÄ±rla</button>
      </div>

      <div id="startMsg" class="small muted" style="margin-top:8px;"></div>

      <div class="hr"></div>

      <h2></span>Takip SorularÄ±</h2>
      <div id="qaBox" class="qa" style="display:none;">
        <div id="questionText" style="margin-bottom:8px; font-weight: 500;"></div>
        <textarea id="answerInput" placeholder="CevabÄ±nÄ±zÄ± yazÄ±n..."></textarea>
        <div class="split" style="margin-top:8px;">
  <button class="btn" id="sendAnswerBtn">YanÄ±tla (sonraki soru)</button>
  <button class="btn secondary" id="skipBtn">Bu soruyu atla</button>
  <button class="btn success" id="doneBtn">Bitir</button>
</div>

        <div id="qaInfo" class="small muted" style="margin-top:6px;"></div>
      </div>

      <div id="noQuestions" class="small muted" style="display:none;">Åžu an sorulacak baÅŸka soru yok.</div>

      <div class="hr"></div>
      <div>
        <h2></span>Oturum Bilgisi</h2>
        <div class="small">Case ID: <span id="caseId" class="pill">-</span></div>
        <div class="small">Son kayÄ±t: <span id="filePath">-</span></div>
      </div>
    </section>

    <!-- SAÄž: CanlÄ± SonuÃ§ Paneli -->
    <aside class="card results-section">
      <h2></span>DeÄŸerlendirme SonuÃ§larÄ±</h2>
      
      <!-- Durum Ã–zeti -->
      <div class="result-summary">
        <div class="status-indicator">
          <span id="colorDot" class="dot green"></span>
          <span class="status-text">DeÄŸerlendirme Durumu</span>
        </div>
        <div class="badges-container">
          <span id="esiBadge" class="badge primary">ESI: -</span>
          <span id="priorityBadge" class="badge secondary">Ã–ncelik: -</span>
          <span id="specBadge" class="badge tertiary">BÃ¶lÃ¼m: -</span>
        </div>
      </div>

      <!-- DeÄŸerlendirme AÃ§Ä±klamasÄ± -->
      <div class="rationale-section">
        <h3>ðŸ“‹ DeÄŸerlendirme AÃ§Ä±klamasÄ±</h3>
        <div class="rationale-content" id="rationale">HenÃ¼z deÄŸerlendirme yapÄ±lmadÄ±. Hasta bilgilerini girin ve deÄŸerlendirmeyi baÅŸlatÄ±n.</div>
      </div>

      <div class="hr"></div>
      
      <!-- Kritik Bulgular -->
      <div class="section-block">
        <h3>Kritik Bulgular (Red Flags)</h3>
        <ul id="redFlags" class="findings-list"></ul>
      </div>

      <div class="hr"></div>
      
      <!-- Ä°lk MÃ¼dahaleler -->
      <div class="section-block">
        <h3>Ä°lk MÃ¼dahaleler</h3>
        <ul id="actions"></ul>
      </div>

      <div class="hr"></div>
      <div>
        <strong>Sorulacak ek sorular (gÃ¼ncel)</strong>
        <ul id="qList"></ul>
      </div>
    </aside>
  </main>

  <script>
    // ------- Ayarlar -------
    const BASE_URL = (localStorage.getItem("TRIAGE_API") || "http://45.87.120.218:9000").replace(/\/$/,'');
    // -----------------------

    // UI helpers
    const $ = (id)=>document.getElementById(id);

    let state = {
      caseId: null,
      remainingQuestions: [],
      lastQuestion: null
    };
    $("doneBtn").addEventListener("click", async ()=>{
  if(!state.caseId) return;
  try{
    const res = await fetch(`${BASE_URL}/triage/${state.caseId}/answer`,{
      method:"PATCH",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ done:true })
    });
    const data = await res.json();

    setESI(data.triage?.triage_level);
    setRouting(data.triage?.routing);
    $("rationale").textContent = data.triage?.rationale_brief || "-";
    renderList("redFlags", data.triage?.red_flags || []);
        renderList("actions", data.triage?.immediate_actions || []);
        renderQuestions("qList", data.triage?.questions_to_ask_next || []);
    setFilePath(data.file_path);

    state.remainingQuestions = [];
    $("qaBox").style.display = "none";
    $("noQuestions").style.display = "block";
  }catch(err){
    alert("Bitirme hatasÄ±: " + err.message);
  }
});
    function setESI(esi){
      const esiBadge = $("esiBadge");
      esiBadge.textContent = "ESI: " + (esi||"-");
      const dot = $("colorDot");
      const resultSummary = document.querySelector(".result-summary");
      
      // Ã–nceki ESI class'larÄ±nÄ± temizle
      resultSummary.className = resultSummary.className.replace(/\besi-[1-5]\b/g, '');
      esiBadge.className = esiBadge.className.replace(/\besi-[1-5]\b/g, '');
      
      if(!esi){ 
        dot.className = "dot green";
        esiBadge.className = "badge primary";
        return; 
      }
      
      // Yeni format: level_1, level_2, vb. veya eski format: esi-1, esi-2, vb.
      let level;
      if(esi.startsWith("level_")){
        level = Number(esi.split("_")[1]);
      } else {
        level = Number((esi+"").split("-")[1]);
      }
      
      // ESI class'Ä±nÄ± result-summary ve esiBadge'e ekle
      resultSummary.classList.add(`esi-${level}`);
      esiBadge.className = `badge esi-${level}`;
      
      if(level<=2){ dot.className = "dot red"; }
      else if(level===3){ dot.className = "dot yellow"; }
      else { dot.className = "dot green"; }
    }
    function setRouting(routing){
      $("priorityBadge").textContent = "Ã–ncelik: " + (routing?.priority || "-");
      $("specBadge").textContent = "BÃ¶lÃ¼m: " + (routing?.specialty || "-");
    }
    function renderList(id, data){
      const ul = $(id); ul.innerHTML = "";
      
      // Yeni format: {primary: [], secondary: []} veya eski format: []
      if(Array.isArray(data)){
        // Eski format - direkt array
        data.forEach(x=>{
          const li = document.createElement("li");
          li.textContent = x;
          ul.appendChild(li);
        });
      } else if(data && typeof data === 'object'){
        // Yeni format - primary/secondary yapÄ±sÄ±
        if(data.primary && data.primary.length > 0){
          const primaryHeader = document.createElement("li");
          primaryHeader.innerHTML = "<strong>Birincil:</strong>";
          primaryHeader.style.color = "var(--danger)";
          ul.appendChild(primaryHeader);
          
          data.primary.forEach(x=>{
            const li = document.createElement("li");
            li.textContent = "â€¢ " + x;
            li.style.marginLeft = "1rem";
            li.style.color = "var(--danger)";
            ul.appendChild(li);
          });
        }
        
        if(data.secondary && data.secondary.length > 0){
          const secondaryHeader = document.createElement("li");
          secondaryHeader.innerHTML = "<strong>Ä°kincil:</strong>";
          secondaryHeader.style.color = "var(--warning)";
          ul.appendChild(secondaryHeader);
          
          data.secondary.forEach(x=>{
            const li = document.createElement("li");
            li.textContent = "â€¢ " + x;
            li.style.marginLeft = "1rem";
            li.style.color = "var(--warning)";
            ul.appendChild(li);
          });
        }
        
        if(data.vital_instability && data.vital_instability.length > 0){
          const vitalHeader = document.createElement("li");
          vitalHeader.innerHTML = "<strong>Vital Ä°nstabilite:</strong>";
          vitalHeader.style.color = "var(--danger)";
          ul.appendChild(vitalHeader);
          
          data.vital_instability.forEach(x=>{
            const li = document.createElement("li");
            li.textContent = "â€¢ " + x;
            li.style.marginLeft = "1rem";
            li.style.color = "var(--danger)";
            ul.appendChild(li);
          });
        }
      }
    }
    
    function renderQuestions(id, data){
      const ul = $(id); ul.innerHTML = "";
      
      // Yeni format: {primary: [], secondary: []} veya eski format: []
      if(Array.isArray(data)){
        // Eski format - direkt array
        data.forEach(x=>{
          const li = document.createElement("li");
          li.textContent = x;
          ul.appendChild(li);
        });
      } else if(data && typeof data === 'object'){
        // Yeni format - primary/secondary yapÄ±sÄ± - sadece sorularÄ± gÃ¶ster, baÅŸlÄ±klarÄ± deÄŸil
        if(data.primary && data.primary.length > 0){
          data.primary.forEach(x=>{
            const li = document.createElement("li");
            li.textContent = x;
            li.style.color = "var(--primary)";
            ul.appendChild(li);
          });
        }
        
        if(data.secondary && data.secondary.length > 0){
          data.secondary.forEach(x=>{
            const li = document.createElement("li");
            li.textContent = x;
            li.style.color = "var(--text-secondary)";
            ul.appendChild(li);
          });
        }
      }
    }
    
    function setFilePath(path){
      const el = $("filePath");
      if(!path){ el.textContent = "-"; return; }
      const isHttp = /^https?:\/\//i.test(path);
      el.innerHTML = isHttp ? `<a class="link" href="${path}" target="_blank">${path}</a>` : `<span class="mono">${path}</span>`;
    }
    function showMessage(elId, text, cls="muted"){
      const el = $(elId);
      el.className = "small " + (cls==="err" ? "err" : cls==="success" ? "success" : "muted");
      el.textContent = text;
    }

    async function startTriage(){
      // giriÅŸleri topla
      const age = Number($("age").value||0);
      const sex = $("sex").value||"F";
      const complaint_text = $("complaint").value.trim();
      const pregnancy = $("pregnancy").value||"any";
      const chief = $("chief").value.trim() || null;

      // vitals JSON parse
      let vitals = {};
      const vt = $("vitals").value.trim();
      if(vt){
        try{ vitals = JSON.parse(vt); }
        catch(e){ showMessage("startMsg","Vitaller geÃ§erli JSON deÄŸil.","err"); return; }
      }

      if(!complaint_text){
        showMessage("startMsg","ÅžikÃ¢yet metni boÅŸ olamaz.","err"); return;
      }

      showMessage("startMsg","GÃ¶nderiliyor...");
      try{
        const res = await fetch(`${BASE_URL}/triage/start`,{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({ age, sex, complaint_text, vitals, pregnancy, chief })
        });
        if(!res.ok){ throw new Error(await res.text()); }
        const data = await res.json();

        // state
        state.caseId = data.case_id;
        
        // Questions formatÄ±nÄ± kontrol et
        const initialQuestions = data.questions_to_ask_next || [];
        let questions = [];
        
        if(Array.isArray(initialQuestions)){
          questions = initialQuestions;
        } else if(initialQuestions && typeof initialQuestions === 'object'){
          // Primary sorularÄ± Ã¶nce, secondary sorularÄ± sonra ekle
          if(initialQuestions.primary) questions.push(...initialQuestions.primary);
          if(initialQuestions.secondary) questions.push(...initialQuestions.secondary);
        }
        
        state.remainingQuestions = [...questions];
        $("caseId").textContent = state.caseId;
        setFilePath(data.file_path);

        // panel gÃ¼ncelle
        setESI(data.triage?.triage_level);
        setRouting(data.triage?.routing);
        $("rationale").textContent = data.triage?.rationale_brief || "-";
        renderList("redFlags", data.triage?.red_flags || []);
        renderList("actions", data.triage?.immediate_actions || []);
        renderQuestions("qList", data.triage?.questions_to_ask_next || []);

        // ilk soruyu aÃ§
        nextQuestionUI();

        showMessage("startMsg","Ä°lk deÄŸerlendirme alÄ±ndÄ±. Sorular sÄ±rayla yÃ¶nlendirilecek.","success");
      }catch(err){
        console.error(err);
        showMessage("startMsg","Hata: " + err.message, "err");
      }
    }
    
    function nextQuestionUI(){
      const box = $("qaBox");
      const none = $("noQuestions");
      if(state.remainingQuestions.length === 0){
        box.style.display = "none";
        none.style.display = "block";
        $("questionText").textContent = "";
        $("answerInput").value = "";
        $("qaInfo").textContent = "";
        return;
      }
      const q = state.remainingQuestions.shift();
      state.lastQuestion = q;
      $("questionText").textContent = "Soru: " + q;
      $("answerInput").value = "";
      $("qaInfo").textContent = `${state.remainingQuestions.length} soru daha var`;
      box.style.display = "block";
      none.style.display = "none";
      $("answerInput").focus();
    }

    async function sendAnswer(skip=false){
      if(!state.caseId) return;
      const q = state.lastQuestion;
      const a = skip ? "" : $("answerInput").value.trim();

      // hiÃ§bir soru gÃ¶sterilmiyorsa Ã§Ä±k
      if(!q){ nextQuestionUI(); return; }

      // cevabÄ± gÃ¶nder
      try{
        $("sendAnswerBtn").disabled = true;
        $("skipBtn").disabled = true;

        const res = await fetch(`${BASE_URL}/triage/${state.caseId}/answer`,{
          method:"PATCH",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({ answers: { [q]: a } })
        });
        if(!res.ok){ throw new Error(await res.text()); }
        const data = await res.json();

        // paneli gÃ¼ncelle
        setESI(data.triage?.triage_level);
        setRouting(data.triage?.routing);
        $("rationale").textContent = data.triage?.rationale_brief || "-";
        renderList("redFlags", data.triage?.red_flags || []);
        renderList("actions", data.triage?.immediate_actions || []);
        renderQuestions("qList", data.triage?.questions_to_ask_next || []);
        setFilePath(data.file_path);

        // yeni sorular: sistemin dÃ¶ndÃ¼rdÃ¼kleri + elimizde kalanlar
        const freshQuestions = data.questions_to_ask_next || [];
        let fresh = [];
        
        // Yeni format kontrolÃ¼
        if(Array.isArray(freshQuestions)){
          fresh = freshQuestions;
        } else if(freshQuestions && typeof freshQuestions === 'object'){
          // Primary sorularÄ± Ã¶nce, secondary sorularÄ± sonra ekle
          if(freshQuestions.primary) fresh.push(...freshQuestions.primary);
          if(freshQuestions.secondary) fresh.push(...freshQuestions.secondary);
        }
        
        // Yeni gelen sorularÄ± kuyruÄŸun SONUNA ekleyelim; tekrarlarÄ± filtreleyelim
        const setQ = new Set([...state.remainingQuestions, ...fresh]);
        state.remainingQuestions = Array.from(setQ);

        // sÄ±radaki soruya geÃ§
        nextQuestionUI();
      }catch(err){
        console.error(err);
        alert("Hata: " + err.message);
      }finally{
        $("sendAnswerBtn").disabled = false;
        $("skipBtn").disabled = false;
      }
    }

    function resetAll(){
      state = { caseId:null, remainingQuestions:[], lastQuestion:null };
      $("caseId").textContent = "-";
      setFilePath("-");
      setESI(null);
      setRouting(null);
      $("rationale").textContent = "HenÃ¼z deÄŸerlendirme yapÄ±lmadÄ±.";
      ["redFlags","actions","qList"].forEach(id=>$(id).innerHTML="");
      $("qaBox").style.display = "none";
      $("noQuestions").style.display = "none";
      $("complaint").value = "";
      $("vitals").value = "";
      showMessage("startMsg", "");
    }

    // events
    $("startBtn").addEventListener("click", startTriage);
    $("sendAnswerBtn").addEventListener("click", ()=>sendAnswer(false));
    $("skipBtn").addEventListener("click", ()=>sendAnswer(true));
    $("resetBtn").addEventListener("click", resetAll);
  </script>
</body>
</html>