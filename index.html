<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Hızlı Değerlendirme (E-Triyaj)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --secondary: #64748b;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-card: #334155;
      --text-primary: #f8fafc;
      --text-secondary: #cbd5e1;
      --text-muted: #94a3b8;
      --border: #475569;
      --border-light: #64748b;
      --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, var(--bg-primary) 0%, #1a202c 100%);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
    }

    header {
      background: rgba(30, 41, 59, 0.8);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
      padding: 2rem 1rem;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    header h1 {
      font-size: clamp(1.5rem, 4vw, 2.5rem);
      font-weight: 700;
      background: linear-gradient(135deg, var(--primary), #8b5cf6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 0.5rem;
    }

    header p {
      color: var(--text-secondary);
      font-size: 1rem;
      max-width: 600px;
      margin: 0 auto;
    }

    main {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 1rem 3rem;
      display: grid;
      grid-template-columns: 1fr;
      gap: 2rem;
    }

    @media (min-width: 768px) {
      main {
        grid-template-columns: 1.2fr 1fr;
        gap: 2.5rem;
      }
    }

    .card {
      background: rgba(51, 65, 85, 0.6);
      backdrop-filter: blur(10px);
      border: 1px solid var(--border);
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      border-color: var(--border-light);
    }

    .card h2 {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .card h2::before {
      content: '';
      width: 4px;
      height: 1.5rem;
      background: linear-gradient(135deg, var(--primary), #8b5cf6);
      border-radius: 2px;
    }

    label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-secondary);
      margin: 1rem 0 0.5rem;
    }

    input, select, textarea {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      background: rgba(30, 41, 59, 0.8);
      color: var(--text-primary);
      font-size: 0.875rem;
      transition: all 0.2s ease;
      outline: none;
    }

    input:focus, select:focus, textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    textarea {
      min-height: 80px;
      resize: vertical;
      font-family: inherit;
    }

    .row, .grid2 {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
    }

    @media (min-width: 640px) {
      .row, .grid2 {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .btn:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }

    .btn.secondary {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-secondary);
    }

    .btn.secondary:hover {
      background: rgba(100, 116, 139, 0.1);
      border-color: var(--border-light);
      transform: translateY(-1px);
      box-shadow: none;
    }

    .split {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
    }

    .split > * {
      flex: 1;
    }

    .status {
      display: flex;
      gap: 0.75rem;
      align-items: center;
      flex-wrap: wrap;
      margin: 1rem 0;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      border-radius: 9999px;
      border: 1px solid var(--border);
      font-weight: 500;
      font-size: 0.75rem;
      background: rgba(30, 41, 59, 0.6);
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .green { background: var(--success); }
    .yellow { background: var(--warning); }
    .red { background: var(--danger); }

    .qa {
      background: rgba(30, 41, 59, 0.4);
      border: 1px dashed var(--border);
      border-radius: 0.75rem;
      padding: 1rem;
      margin: 1rem 0;
    }

    .hr {
      height: 1px;
      background: var(--border);
      margin: 1.5rem 0;
      border: none;
    }

    .small {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .muted {
      color: var(--text-muted);
    }

    .success { color: var(--success); }
    .warn { color: var(--warning); }
    .err { color: var(--danger); }

    .link {
      color: var(--primary);
      text-decoration: none;
      transition: color 0.2s ease;
    }

    .link:hover {
      color: var(--primary-dark);
      text-decoration: underline;
    }

    .mono {
      font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
      font-size: 0.75rem;
    }

    ul {
      margin: 0.5rem 0 0 1.25rem;
      padding: 0;
    }

    li {
      margin: 0.25rem 0;
      color: var(--text-secondary);
    }

    /* Responsive improvements */
    @media (max-width: 640px) {
      header {
        padding: 1.5rem 1rem;
      }
      
      main {
        margin: 1rem auto;
        padding: 0 0.75rem 2rem;
      }
      
      .card {
        padding: 1rem;
      }
      
      .split {
        flex-direction: column;
      }
    }

    /* Loading animation */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .loading {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
  </style>
</head>
<body>
  <header>
    <h1>Hızlı Değerlendirme (E-Triyaj)</h1>
    <p>Şikâyeti gir → ilk değerlendirme → sistemin sorduğu soruları aynı sayfada yanıtla.</p>
    <p style="font-size: 0.875rem; color: var(--text-muted); margin-top: 0.5rem;">Güncellenmiş format: Yapılandırılmış kategoriler, detaylı ESI kriterleri ve öncelikli soru sistemi</p>
  </header>

  <main>
    <!-- SOL: Giriş & Soru Akışı -->
    <section class="card">
      <h2>1) Hasta Bilgisi</h2>

      <div class="row">
        <div>
          <label>Yaş</label>
          <input id="age" type="number" min="0" value="30" />
        </div>
        <div>
          <label>Cinsiyet</label>
          <select id="sex">
            <option value="F">F</option>
            <option value="M">M</option>
          </select>
        </div>
      </div>

      <label>Şikâyet metni</label>
      <textarea id="complaint" placeholder="örn. göğsümde baskı var, nefes almakta zorlanıyorum"></textarea>

      <div class="grid2">
        <div>
          <label>Gebelik</label>
          <select id="pregnancy">
            <option value="any" selected>any</option>
            <option value="positive">positive</option>
            <option value="negative">negative</option>
          </select>
        </div>
        <div>
          <label>Chief (opsiyonel)</label>
          <input id="chief" placeholder="örn. chest pain / göğüs ağrısı" />
        </div>
      </div>

      <label>Vitaller (JSON, opsiyonel)</label>
      <textarea id="vitals" class="mono" placeholder='örn. {"HR": 110, "RR": 24, "SpO2": 93, "SBP": 118, "Temp": 37.8}'></textarea>

      <div class="hr"></div>
      <div class="split">
        <button class="btn" id="startBtn">İlk gönder</button>
        <button class="btn secondary" id="resetBtn">Sıfırla</button>
      </div>

      <div id="startMsg" class="small muted" style="margin-top:8px;"></div>

      <div class="hr"></div>

      <h2>2) Takip Soruları</h2>
      <div id="qaBox" class="qa" style="display:none;">
        <div id="questionText" style="margin-bottom:8px;"></div>
        <textarea id="answerInput" placeholder="Cevabınızı yazın..."></textarea>
        <div class="split" style="margin-top:8px;">
  <button class="btn" id="sendAnswerBtn">Yanıtla (sonraki soru)</button>
  <button class="btn secondary" id="skipBtn">Bu soruyu atla</button>
  <button class="btn secondary" id="doneBtn">Bitir</button>
</div>

        <div id="qaInfo" class="small muted" style="margin-top:6px;"></div>
      </div>

      <div id="noQuestions" class="small muted" style="display:none;">Şu an sorulacak başka soru yok.</div>

      <div class="hr"></div>
      <div>
        <h2>3) Oturum Bilgisi</h2>
        <div class="small">Case ID: <span id="caseId" class="pill">-</span></div>
        <div class="small">Son kayıt: <span id="filePath">-</span></div>
      </div>
    </section>

    <!-- SAĞ: Canlı Sonuç Paneli -->
    <aside class="card">
      <h2>Sonuç Paneli</h2>
      <div class="status" style="margin-bottom:8px;">
        <span id="colorDot" class="dot green"></span>
        <span id="esiBadge" class="badge">ESI: -</span>
        <span id="priorityBadge" class="badge">Öncelik: -</span>
        <span id="specBadge" class="badge">Bölüm: -</span>
      </div>
      <div class="small muted" id="rationale">Henüz değerlendirme yapılmadı.</div>

      <div class="hr"></div>
      <div>
        <strong>Red flags</strong>
        <ul id="redFlags"></ul>
      </div>

      <div class="hr"></div>
      <div>
        <strong>İlk eylemler</strong>
        <ul id="actions"></ul>
      </div>

      <div class="hr"></div>
      <div>
        <strong>Sorulacak ek sorular (güncel)</strong>
        <ul id="qList"></ul>
      </div>
    </aside>
  </main>

  <script>
    // ------- Ayarlar -------
    const BASE_URL = (localStorage.getItem("TRIAGE_API") || "http://45.87.120.218:9000").replace(/\/$/,'');
    // -----------------------

    // UI helpers
    const $ = (id)=>document.getElementById(id);

    let state = {
      caseId: null,
      remainingQuestions: [],
      lastQuestion: null
    };
    $("doneBtn").addEventListener("click", async ()=>{
  if(!state.caseId) return;
  try{
    const res = await fetch(`${BASE_URL}/triage/${state.caseId}/answer`,{
      method:"PATCH",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ done:true })
    });
    const data = await res.json();

    setESI(data.triage?.triage_level);
    setRouting(data.triage?.routing);
    $("rationale").textContent = data.triage?.rationale_brief || "-";
    renderList("redFlags", data.triage?.red_flags || []);
        renderList("actions", data.triage?.immediate_actions || []);
        renderQuestions("qList", data.triage?.questions_to_ask_next || []);
    setFilePath(data.file_path);

    state.remainingQuestions = [];
    $("qaBox").style.display = "none";
    $("noQuestions").style.display = "block";
  }catch(err){
    alert("Bitirme hatası: " + err.message);
  }
});
    function setESI(esi){
      $("esiBadge").textContent = "ESI: " + (esi||"-");
      const dot = $("colorDot");
      if(!esi){ dot.className = "dot green"; return; }
      
      // Yeni format: level_1, level_2, vb. veya eski format: esi-1, esi-2, vb.
      let level;
      if(esi.startsWith("level_")){
        level = Number(esi.split("_")[1]);
      } else {
        level = Number((esi+"").split("-")[1]);
      }
      
      if(level<=2){ dot.className = "dot red"; }
      else if(level===3){ dot.className = "dot yellow"; }
      else { dot.className = "dot green"; }
    }
    function setRouting(routing){
      $("priorityBadge").textContent = "Öncelik: " + (routing?.priority || "-");
      $("specBadge").textContent = "Bölüm: " + (routing?.specialty || "-");
    }
    function renderList(id, data){
      const ul = $(id); ul.innerHTML = "";
      
      // Yeni format: {primary: [], secondary: []} veya eski format: []
      if(Array.isArray(data)){
        // Eski format - direkt array
        data.forEach(x=>{
          const li = document.createElement("li");
          li.textContent = x;
          ul.appendChild(li);
        });
      } else if(data && typeof data === 'object'){
        // Yeni format - primary/secondary yapısı
        if(data.primary && data.primary.length > 0){
          const primaryHeader = document.createElement("li");
          primaryHeader.innerHTML = "<strong>Birincil:</strong>";
          primaryHeader.style.color = "var(--danger)";
          ul.appendChild(primaryHeader);
          
          data.primary.forEach(x=>{
            const li = document.createElement("li");
            li.textContent = "• " + x;
            li.style.marginLeft = "1rem";
            li.style.color = "var(--danger)";
            ul.appendChild(li);
          });
        }
        
        if(data.secondary && data.secondary.length > 0){
          const secondaryHeader = document.createElement("li");
          secondaryHeader.innerHTML = "<strong>İkincil:</strong>";
          secondaryHeader.style.color = "var(--warning)";
          ul.appendChild(secondaryHeader);
          
          data.secondary.forEach(x=>{
            const li = document.createElement("li");
            li.textContent = "• " + x;
            li.style.marginLeft = "1rem";
            li.style.color = "var(--warning)";
            ul.appendChild(li);
          });
        }
        
        if(data.vital_instability && data.vital_instability.length > 0){
          const vitalHeader = document.createElement("li");
          vitalHeader.innerHTML = "<strong>Vital İnstabilite:</strong>";
          vitalHeader.style.color = "var(--danger)";
          ul.appendChild(vitalHeader);
          
          data.vital_instability.forEach(x=>{
            const li = document.createElement("li");
            li.textContent = "• " + x;
            li.style.marginLeft = "1rem";
            li.style.color = "var(--danger)";
            ul.appendChild(li);
          });
        }
      }
    }
    
    function renderQuestions(id, data){
      const ul = $(id); ul.innerHTML = "";
      
      // Yeni format: {primary: [], secondary: []} veya eski format: []
      if(Array.isArray(data)){
        // Eski format - direkt array
        data.forEach(x=>{
          const li = document.createElement("li");
          li.textContent = x;
          ul.appendChild(li);
        });
      } else if(data && typeof data === 'object'){
        // Yeni format - primary/secondary yapısı - sadece soruları göster, başlıkları değil
        if(data.primary && data.primary.length > 0){
          data.primary.forEach(x=>{
            const li = document.createElement("li");
            li.textContent = x;
            li.style.color = "var(--primary)";
            ul.appendChild(li);
          });
        }
        
        if(data.secondary && data.secondary.length > 0){
          data.secondary.forEach(x=>{
            const li = document.createElement("li");
            li.textContent = x;
            li.style.color = "var(--text-secondary)";
            ul.appendChild(li);
          });
        }
      }
    }
    
    function setFilePath(path){
      const el = $("filePath");
      if(!path){ el.textContent = "-"; return; }
      const isHttp = /^https?:\/\//i.test(path);
      el.innerHTML = isHttp ? `<a class="link" href="${path}" target="_blank">${path}</a>` : `<span class="mono">${path}</span>`;
    }
    function showMessage(elId, text, cls="muted"){
      const el = $(elId);
      el.className = "small " + (cls==="err" ? "err" : cls==="success" ? "success" : "muted");
      el.textContent = text;
    }

    async function startTriage(){
      // girişleri topla
      const age = Number($("age").value||0);
      const sex = $("sex").value||"F";
      const complaint_text = $("complaint").value.trim();
      const pregnancy = $("pregnancy").value||"any";
      const chief = $("chief").value.trim() || null;

      // vitals JSON parse
      let vitals = {};
      const vt = $("vitals").value.trim();
      if(vt){
        try{ vitals = JSON.parse(vt); }
        catch(e){ showMessage("startMsg","Vitaller geçerli JSON değil.","err"); return; }
      }

      if(!complaint_text){
        showMessage("startMsg","Şikâyet metni boş olamaz.","err"); return;
      }

      showMessage("startMsg","Gönderiliyor...");
      try{
        const res = await fetch(`${BASE_URL}/triage/start`,{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({ age, sex, complaint_text, vitals, pregnancy, chief })
        });
        if(!res.ok){ throw new Error(await res.text()); }
        const data = await res.json();

        // state
        state.caseId = data.case_id;
        
        // Questions formatını kontrol et
        const initialQuestions = data.questions_to_ask_next || [];
        let questions = [];
        
        if(Array.isArray(initialQuestions)){
          questions = initialQuestions;
        } else if(initialQuestions && typeof initialQuestions === 'object'){
          // Primary soruları önce, secondary soruları sonra ekle
          if(initialQuestions.primary) questions.push(...initialQuestions.primary);
          if(initialQuestions.secondary) questions.push(...initialQuestions.secondary);
        }
        
        state.remainingQuestions = [...questions];
        $("caseId").textContent = state.caseId;
        setFilePath(data.file_path);

        // panel güncelle
        setESI(data.triage?.triage_level);
        setRouting(data.triage?.routing);
        $("rationale").textContent = data.triage?.rationale_brief || "-";
        renderList("redFlags", data.triage?.red_flags || []);
        renderList("actions", data.triage?.immediate_actions || []);
        renderQuestions("qList", data.triage?.questions_to_ask_next || []);

        // ilk soruyu aç
        nextQuestionUI();

        showMessage("startMsg","İlk değerlendirme alındı. Sorular sırayla yönlendirilecek.","success");
      }catch(err){
        console.error(err);
        showMessage("startMsg","Hata: " + err.message, "err");
      }
    }
    
    function nextQuestionUI(){
      const box = $("qaBox");
      const none = $("noQuestions");
      if(state.remainingQuestions.length === 0){
        box.style.display = "none";
        none.style.display = "block";
        $("questionText").textContent = "";
        $("answerInput").value = "";
        $("qaInfo").textContent = "";
        return;
      }
      const q = state.remainingQuestions.shift();
      state.lastQuestion = q;
      $("questionText").textContent = "Soru: " + q;
      $("answerInput").value = "";
      $("qaInfo").textContent = `${state.remainingQuestions.length} soru daha var`;
      box.style.display = "block";
      none.style.display = "none";
      $("answerInput").focus();
    }

    async function sendAnswer(skip=false){
      if(!state.caseId) return;
      const q = state.lastQuestion;
      const a = skip ? "" : $("answerInput").value.trim();

      // hiçbir soru gösterilmiyorsa çık
      if(!q){ nextQuestionUI(); return; }

      // cevabı gönder
      try{
        $("sendAnswerBtn").disabled = true;
        $("skipBtn").disabled = true;

        const res = await fetch(`${BASE_URL}/triage/${state.caseId}/answer`,{
          method:"PATCH",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({ answers: { [q]: a } })
        });
        if(!res.ok){ throw new Error(await res.text()); }
        const data = await res.json();

        // paneli güncelle
        setESI(data.triage?.triage_level);
        setRouting(data.triage?.routing);
        $("rationale").textContent = data.triage?.rationale_brief || "-";
        renderList("redFlags", data.triage?.red_flags || []);
        renderList("actions", data.triage?.immediate_actions || []);
        renderQuestions("qList", data.triage?.questions_to_ask_next || []);
        setFilePath(data.file_path);

        // yeni sorular: sistemin döndürdükleri + elimizde kalanlar
        const freshQuestions = data.questions_to_ask_next || [];
        let fresh = [];
        
        // Yeni format kontrolü
        if(Array.isArray(freshQuestions)){
          fresh = freshQuestions;
        } else if(freshQuestions && typeof freshQuestions === 'object'){
          // Primary soruları önce, secondary soruları sonra ekle
          if(freshQuestions.primary) fresh.push(...freshQuestions.primary);
          if(freshQuestions.secondary) fresh.push(...freshQuestions.secondary);
        }
        
        // Yeni gelen soruları kuyruğun SONUNA ekleyelim; tekrarları filtreleyelim
        const setQ = new Set([...state.remainingQuestions, ...fresh]);
        state.remainingQuestions = Array.from(setQ);

        // sıradaki soruya geç
        nextQuestionUI();
      }catch(err){
        console.error(err);
        alert("Hata: " + err.message);
      }finally{
        $("sendAnswerBtn").disabled = false;
        $("skipBtn").disabled = false;
      }
    }

    function resetAll(){
      state = { caseId:null, remainingQuestions:[], lastQuestion:null };
      $("caseId").textContent = "-";
      setFilePath("-");
      setESI(null);
      setRouting(null);
      $("rationale").textContent = "Henüz değerlendirme yapılmadı.";
      ["redFlags","actions","qList"].forEach(id=>$(id).innerHTML="");
      $("qaBox").style.display = "none";
      $("noQuestions").style.display = "none";
      $("complaint").value = "";
      $("vitals").value = "";
      showMessage("startMsg", "");
    }

    // events
    $("startBtn").addEventListener("click", startTriage);
    $("sendAnswerBtn").addEventListener("click", ()=>sendAnswer(false));
    $("skipBtn").addEventListener("click", ()=>sendAnswer(true));
    $("resetBtn").addEventListener("click", resetAll);
  </script>
</body>
</html>